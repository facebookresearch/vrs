<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-RecordFormat" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Record Format | VRS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://facebookresearch.github.io/vrs/docs/RecordFormat"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Record Format | VRS"><meta data-rh="true" name="description" content="Record Format Version"><meta data-rh="true" property="og:description" content="Record Format Version"><link data-rh="true" rel="icon" href="/vrs/img/VRS-Icon.svg"><link data-rh="true" rel="canonical" href="https://facebookresearch.github.io/vrs/docs/RecordFormat"><link data-rh="true" rel="alternate" href="https://facebookresearch.github.io/vrs/docs/RecordFormat" hreflang="en"><link data-rh="true" rel="alternate" href="https://facebookresearch.github.io/vrs/docs/RecordFormat" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Record Format","item":"https://facebookresearch.github.io/vrs/docs/RecordFormat"}]}</script><link rel="stylesheet" href="/vrs/assets/css/styles.66491a5e.css">
<script src="/vrs/assets/js/runtime~main.30878bf5.js" defer="defer"></script>
<script src="/vrs/assets/js/main.27179431.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/vrs/"><div class="navbar__logo"><img src="/vrs/img/VRS-Icon.svg" alt="VRS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/vrs/img/VRS-Icon.svg" alt="VRS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">VRS</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/vrs/docs/Overview">Documentation</a><a href="/vrs/doxygen/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">C++ API Documentation<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://github.com/facebookresearch/vrs#getting-started" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Build Instructions<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/facebookresearch/vrs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/Overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/Organization">Organization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/FileStructure">File Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/FileCreation">File Creation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/FilePlayback">File Playback</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/vrs/docs/RecordFormat">Record Format</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/ImageSupport">Image Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/FileHandler">The FileHandler Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/VrsCliTool">The vrs Command Line Tool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/vrsplayer">The vrsplayer App</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/vrs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Record Format</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Record Format</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="record-format-version">Record Format Version<a href="#record-format-version" class="hash-link" aria-label="Direct link to Record Format Version" title="Direct link to Record Format Version">​</a></h2>
<p>Each record in a stream has its own format version number, which is a <code>uint32_t</code> value. However, because records belong to a single stream and each has a record type (Configuration, State, or Data), format version numbers are only meaningful within that stream and for that record type. You do not need to worry about format version collisions between streams and record types.</p>
<p>Before <code>RecordFormat</code> was available, record format versioning was critical, because it was the only information about how the record&#x27;s data was formatted. You were responsible for interpreting every byte of data. You also had to manually manage all data format changes. Since record data formats were not self-described within the file, each time you needed to add, remove, or change a field, you had to change the format version, and handle a growing number of format versions explicitly in the code. This was unmanageable.</p>
<p><code>RecordFormat</code> and <code>DataLayout</code> were designed to solve this challenge, and since, record format version changes are very rarely needed. <code>RecordFormat</code> abstracts the description of a record as a succession of typed blocks, embedding descriptions, including <code>DataLayout</code> definitions, in the stream itself. VRS uses these embedded descriptions to interpret records, calculate content block boundaries using DataLayout Conventions, and pass parsed content blocks to callbacks.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="recordformat"><code>RecordFormat</code><a href="#recordformat" class="hash-link" aria-label="Direct link to recordformat" title="Direct link to recordformat">​</a></h2>
<p>Use <code>RecordFormat</code> to describe records as a sequence of typed content blocks. This structure applies to configuration, state, and data records alike.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contentblock"><code>ContentBlock</code><a href="#contentblock" class="hash-link" aria-label="Direct link to contentblock" title="Direct link to contentblock">​</a></h3>
<p>The content block types are: <code>image</code>, <code>audio</code>, <code>datalayout</code>, and <code>custom</code>. VRS saves <code>RecordFormat</code> definitions as a string that is generated and parsed for you, but which was designed to be very expressive and compact. Content block descriptions may contain additional information, specific to the content type. Here are some examples of single content block <code>RecordFormat</code> definitions:</p>
<ul>
<li><code>image</code></li>
<li><code>image/png</code></li>
<li><code>image/raw</code></li>
<li><code>image/raw/640x480/pixel=grb8</code></li>
<li><code>image/raw/640x480/pixel=grey8/stride=648</code></li>
<li><code>image/video</code></li>
<li><code>image/video/codec=H.264</code></li>
<li><code>audio</code></li>
<li><code>audio/pcm</code></li>
<li><code>audio/pcm/uint24be/rate=32000/channels=1</code></li>
<li><code>datalayout</code></li>
<li><code>datalayout/size=48</code></li>
<li><code>custom</code></li>
<li><code>custom/size=160</code></li>
</ul>
<p><code>image</code> and <code>audio</code> content blocks are pretty much what you expect when you read their text description. <code>datalayout</code> blocks contain structured metadata information. <code>custom</code> content blocks are blocks of raw data, which format is known only to you, and which you are responsible for interpreting.</p>
<p>You can assemble as many content blocks as you like in a record, which might look like this:</p>
<ul>
<li><code>datalayout+image/raw</code></li>
<li><code>datalayout+datalayout+audio/pcm</code></li>
</ul>
<p>Again, these text descriptions are generated and parsed for you, so you don&#x27;t need to worry about their syntax.</p>
<p>The <code>RecordFormat</code> and <code>DataLayout</code> descriptions of a stream&#x27;s records are stored in the VRS tags of the stream. You will only see these text descriptions when you are using tools to dump a stream&#x27;s VRS tags. VRS tags are associated with each stream for VRS internal usage, and are kept separate from the user stream tags.</p>
<p>In practice, the majority of the records used in VRS today use one of the following record formats:</p>
<ul>
<li><code>datalayout</code>: for records containing a single metadata content block, which is typical of configuration records.</li>
<li><code>datalayout+image/raw</code>: for records containing some image specific metadata and the raw pixel data of an image.</li>
<li><code>datalayout+image/jpg</code> and <code>datalayout+image/video</code>: for records containing some image specific metadata and compressed image data.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="datalayout-content-blocks">Datalayout Content Blocks<a href="#datalayout-content-blocks" class="hash-link" aria-label="Direct link to Datalayout Content Blocks" title="Direct link to Datalayout Content Blocks">​</a></h3>
<p>Datalayout content blocks, commonly referred to as datalayouts, are <code>DataLayout</code> objects that hold containers of <a href="https://en.wikipedia.org/wiki/Passive_data_structure" target="_blank" rel="noopener noreferrer">POD values</a> and strings. If you have never seen a <code>DataLayout</code> definition, look at the <code>MyDataLayout</code> definition in the <strong><code>DataLayout</code> Examples</strong> section below.</p>
<p><code>DataLayout</code> are <code>struct</code> objects containing <code>DataPieceXXX</code> member variables, that each have their own text label. The supported <code>DataPieceXXX</code> types are:</p>
<p><code>DataPieceValue</code>, a single value of POD type <code>T</code>:</p>
<ul>
<li>Type: <code>template &lt;class T&gt; DataPieceValue&lt;T&gt;;</code></li>
<li>Example: <code>DataPieceValue&lt;int32_t&gt; exposure{&quot;exposure&quot;};</code></li>
</ul>
<p><code>DataPieceEnum</code>, a single value of enum <code>ENUM_TYPE</code> with the underlying type <code>POD_TYPE</code>:</p>
<ul>
<li>Type: <code>template &lt;typename ENUM_TYPE, typename POD_TYPE&gt; DataPieceEnum&lt;ENUM_TYPE, POD_TYPE&gt;</code></li>
<li>Example: <code>DataPieceEnum&lt;PixelFormat, uint32_t&gt; pixelFormat{&quot;pixel_format&quot;};</code></li>
</ul>
<p><code>DataPieceArray</code>, a fixed size array of values of POD type <code>T</code>:</p>
<ul>
<li>Type: <code>template &lt;class T&gt; DataPieceArray&lt;T&gt;;</code></li>
<li>Example: <code>DataPieceArray&lt;float&gt; calibration{&quot;calibration&quot;, 25};</code></li>
</ul>
<p><code>DataPieceVector</code>, a vector of values of type <code>T</code>, which size may change for each record:</p>
<ul>
<li>Type: <code>template &lt;class T&gt; DataPieceVector&lt;T&gt;</code></li>
<li>Example: <code>DataPieceVector&lt;int8_t&gt; udpPayload{&quot;udp_payload&quot;};</code></li>
</ul>
<p><code>DataPieceStringMap</code>, the equivalent of <code>std::map&lt;std::string, T&gt;</code>:</p>
<ul>
<li>Type: <code>template &lt;class T&gt; DataPieceStringMap&lt;T&gt;</code></li>
<li>Example: <code>DataPieceStringMap&lt;Point2Di&gt; labelledPoints{&quot;labelled_points&quot;};</code></li>
</ul>
<p><code>DataPieceString</code>, a <code>std::string</code> value:</p>
<ul>
<li>Type: <code>DataPieceString</code></li>
<li>Example: <code>DataPieceString message{&quot;message&quot;};</code></li>
</ul>
<p>Template class <code>T</code> can be any of these built-in POD types:</p>
<ul>
<li>Boolean (use <code>vrs::Bool</code>)</li>
<li>Signed or unsigned integer (8, 16, 32, or 64 bits)</li>
<li>32 bit float</li>
<li>64 bit double</li>
</ul>
<p>Template class <code>T</code> can also be any of these vector types (using <code>float</code>, <code>double</code> or <code>int32_t</code> for coordinates):</p>
<ul>
<li>2, 3, or 4D points</li>
<li>3 or 4D matrices</li>
</ul>
<p><code>std::string</code> can be used with <code>DataPieceVector&lt;T&gt;</code> and <code>DataPieceStringMap&lt;T&gt;</code>, but cannot be used with the other template types.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Always use <code>&lt;cstdint&gt;</code> definitions. Never use platform dependent types like <code>short</code>, <code>int</code>, <code>long</code>, or <code>size_t</code>. The actual size will vary depending on the architecture or the compiler configuration.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="datalayout-format-resilience"><code>DataLayout</code> Format Resilience<a href="#datalayout-format-resilience" class="hash-link" aria-label="Direct link to datalayout-format-resilience" title="Direct link to datalayout-format-resilience">​</a></h3>
<p><code>DataLayout</code> objects are structs, so it is very simple to add, remove, and reorder <code>DataPieceXXX</code> fields. But datalayouts definitions are very resilient to definition changes, so that even when making such changes, newer code can read older files, and older code can read newer files.</p>
<p>Datalayouts format resilience is possible, because each <code>DataPieceXXX</code> object is identified by a unique combination of these elements:</p>
<ul>
<li><code>DataPiece</code> type</li>
<li>Label</li>
<li>Template class <code>T</code>, except for <code>DataPieceString</code></li>
</ul>
<p>This unique combination is critical to providing datalayout forward/backward compatibility, without worrying about the actual placement of the data. If you change the type or the label of a field, you will change its signature, and it won&#x27;t be recognized in older files. The modified field will look like a new field, and the data from older files will no longer be accessible using the updated definition.</p>
<p><code>DataLayout</code> definitions do not support other types of containers or nested containers, because that would make it impossible to guarantee forward/backward compatibility. However, it is possible to use repeated and nested structs, using <code>DataLayoutStruct</code>, as shown in the second example below.</p>
<p>In some situations, such as when you need to save space, it is desirable to store some fields only in some conditions. The <code>OptionalDataPieces</code> template makes it easy to specify and control if a group of fields should be saved or not, but the choice must be made once for the whole file.</p>
<p>If you need more freedom, you can use a free form container such as JSON in a <code>DataPieceString</code> field. If you have binary data, you can use a <code>DataPieceVector&lt;uint8_t&gt;</code> field.</p>
<p>We recommend that you use lowercase <a href="https://en.wikipedia.org/wiki/Snake_case" target="_blank" rel="noopener noreferrer">snake_case</a> as your naming convention for labels. This will limit problems if these names are used as keys in a Python dictionary, in particular when using <strong>pyvrs</strong> to create or read datalayouts.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="datalayout-examples"><code>DataLayout</code> Examples<a href="#datalayout-examples" class="hash-link" aria-label="Direct link to datalayout-examples" title="Direct link to datalayout-examples">​</a></h3>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Example 1: standard case</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Example 2: nested definitions</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Example 3: optional definitions</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p>Here is a sample <code>DataLayout</code> definition:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">MyDataLayout</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="font-style:italic">public</span><span class="token base-clause"> </span><span class="token base-clause class-name" style="color:rgb(255, 203, 107)">AutoDataLayout</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Fixed size pieces: std::string is NOT supported as a template type.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceValue</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token keyword" style="font-style:italic">double</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> exposureTime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;exposure_time&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceValue</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token keyword" style="font-style:italic">uint64_t</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> frameCounter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;frame_counter&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceValue</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token keyword" style="font-style:italic">float</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> cameraTemperature</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;camera_temperature&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceEnum</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">PixelFormat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">uint32_t</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> pixelFormat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pixel_format&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceArray</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">Matrix3Dd</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> arrayOfMatrix3Dd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;matrices&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// array size = 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Variable size pieces: std::string is supported as a template type.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceVector</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">Point3Df</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> vectorOfPoint3Df</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;points&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceVector</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">string</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> vectorOfString</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;strings&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceString description</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;description&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Any string. Could be json.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceStringMap</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">Matrix4Dd</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> aStringMatrixMap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;some_string_to_matrix4d_map&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceStringMap</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">string</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> aStringStringMap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;some_string_to_string_map&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  AutoDataLayoutEnd endLayout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div><p>Notice that this struct must derive from <code>AutoDataLayout</code>, and finish with an <code>AutoDataLayoutEnd</code> field. This is required to make the <code>DataLayout</code> magic happen. Under the hood, the <code>DataPieceXXX</code> constructors will register themselves to the enclosing <code>AutoDataLayout</code>. As we will generally only create a single <code>DataLayout</code> instance, the overhead is minimal and does not matter. Also, notice that each field has a unique label.</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This option is not commonly needed.</p></div></div><p>It is possible to define structs that can be nested in a DataLayout definition. For example:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Pose</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="font-style:italic">public</span><span class="token base-clause"> </span><span class="token base-clause class-name" style="color:rgb(255, 203, 107)">DataLayoutStruct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">DATA_LAYOUT_STRUCT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Pose</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// repeat the name of the struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceVector</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">vrs</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Matrix4Dd</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> orientation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;orientation&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceVector</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">vrs</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Matrix3Dd</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> translation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;translation&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">MyDataLayout</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="font-style:italic">public</span><span class="token base-clause"> </span><span class="token base-clause class-name" style="color:rgb(255, 203, 107)">AutoDataLayout</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Pose leftHand</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;left_hand&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Pose rightHand</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;right_hand&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  AutoDataLayoutEnd endLayout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div><p>The name of each field in the <code>DataLayoutStruct</code> is prepended by the name of the <code>DataLayoutStruct</code> itself, with a ‘<code>/</code>’ added to make it look like a path. This also makes it unique at the datalayout level.</p><p>Effectively, the declaration above creates the same <code>DataPiece</code> fields and the same datalayout definition as the datalayout definition below, which requires different member variable names to avoid conflicts at the struct level:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">MyDataLayout</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="font-style:italic">public</span><span class="token base-clause"> </span><span class="token base-clause class-name" style="color:rgb(255, 203, 107)">AutoDataLayout</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceVector</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">vrs</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Matrix4Dd</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> leftHandOrientation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;left_hand/orientation&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceVector</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">vrs</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Matrix3Dd</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> leftHandTranslation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;left_hand/translation&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceVector</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">vrs</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Matrix4Dd</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> rightHandOrientation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;right_hand/orientation&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceVector</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">vrs</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Matrix3Dd</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> rightHandTranslation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;right_hand/translation&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  AutoDataLayoutEnd endLayout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div><p>It is possible to nest a <code>DataLayoutStruct</code> within other <code>DataLayoutStruct</code> definitions as often as makes sense. The resulting <code>DataPiece</code> fields will have labels similarly constructed, with deeper nesting. However, it is not possible to use <code>DataLayoutStruct</code> definitions in template containers.</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This option is only very rarely needed.</p></div></div><p>You can define fields that are used only when some recording conditions are met, or with some devices. This helps to save space, and makes the records less ambiguous, since they will only show these fields if they were actually used while recording.</p><p>For example:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/// Sample sensor not always available on all devices</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">TemperatureData</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceValue</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token keyword" style="font-style:italic">float</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> cameraTemperature</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;camera_temperature&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">MyDataLayout</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="font-style:italic">public</span><span class="token base-clause"> </span><span class="token base-clause class-name" style="color:rgb(255, 203, 107)">AutoDataLayout</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">MyDataLayout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> allocateOptionalFields </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">optionalFields</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">allocateOptionalFields</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceValue</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token keyword" style="font-style:italic">double</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> exposureTime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;exposure_time&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  DataPieceValue</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token keyword" style="font-style:italic">uint64_t</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> frameCounter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;frame_counter&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> OptionalDataPieces</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">TemperatureData</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> optionalTemperature</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  AutoDataLayoutEnd endLayout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div><p>When recording a file, you need to decide upfront, at runtime, whether the optional fields are needed for this recording, and then select the appropriate constructor. This is because the optional fields must be allocated during the datalayout construction.</p><p>When reading a file, you can try to use the appropriate constructor, or you can always include the optional fields and test if data is present by checking the <code>isAvailable()</code> method for each optional field.</p></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="image-audio-and-custom-content-blocks">Image, Audio, and Custom Content Blocks<a href="#image-audio-and-custom-content-blocks" class="hash-link" aria-label="Direct link to Image, Audio, and Custom Content Blocks" title="Direct link to Image, Audio, and Custom Content Blocks">​</a></h3>
<p>Image, audio, and custom content blocks directly contain their payload, and no additional metadata. In some cases, such as for <code>image/jpg</code> or <code>image/png</code> data, no other information is needed to interpret the data. In other cases, such with <code>images/raw</code> images, which are raw pixel buffers, image dimensions, pixel format and possibly stride information are required to know how to interpret the image content block. If that information never changes, it may provided directly in the <code>RecordFormat</code> definition, otherwise, it might need to be provided in a configuration record, or in the data records themselves, using what we call the Datalayout Conventions.</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Image Content Block Examples</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Audio Content Block Examples</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Custom Content Block Examples</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ContentType</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">IMAGE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Image content block, without any detail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ContentType</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">JPG</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// A jpeg image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ContentType</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">JPG</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">640</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">480</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// A 640x480 jpeg image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ContentType</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">RAW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// A raw pixel buffer image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">PixelFormat</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">GREY8</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">640</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">480</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// A raw pixel buffer image, 640x480 large, with 8 bit greyscale pixels.</span><br></span></code></pre></div></div><p>Please refer to the Image Support section for more details on how to manage image content blocks.</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ContentType</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">AUDIO</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Audio content block, without any detail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AudioFormat</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">PCM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// PCM audio data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AudioSampleFormat</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">S16_LE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">48000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// PCM audio data, int16 little endian samples, 2 channels, 48 kHz</span><br></span></code></pre></div></div><p>Audio blocks are analog to image blocks, and are handled the same way.</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ContentType</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">CUSTOM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// No details at all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ContentType</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">CUSTOM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">256</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 256 byte custom content block</span><br></span></code></pre></div></div><p>If they are not the last content block in the record, custom content blocks may need to have their size provided using the Datalayout conventions.</p></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="registering-your-recordformat-and-datalayout-definitions">Registering your <code>RecordFormat</code> and <code>DataLayout</code> Definitions<a href="#registering-your-recordformat-and-datalayout-definitions" class="hash-link" aria-label="Direct link to registering-your-recordformat-and-datalayout-definitions" title="Direct link to registering-your-recordformat-and-datalayout-definitions">​</a></h2>
<p>When you create a <code>Recordable</code> object to record a stream, you need to register the <code>RecordFormat</code> for its records. For example:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Assuming your recordable has a member variable declared like so:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MyDataLayout config_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// in your Recordable&#x27;s constructor, call:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">addRecordFormat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Record</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Type</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">CONFIGURATION</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// record types are defined separately</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  kConfigurationRecordFormatVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// only change when the RecordFormat changes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  config_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">getContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// RecordFormat definition: a single datalayout block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">config_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// DataLayout definition for the first block</span><br></span></code></pre></div></div>
<p>Here is an example of a record that contains a datalayout block, followed by an image block (“<code>datalayout+image/raw</code>”):</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Assuming your recordable has a member variable declared like so:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MyDataLayoutForDataRecords data_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// in your Recordable&#x27;s constructor, call:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">addRecordFormat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Record</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Type</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">DATA</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// record types are defined separately</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  kDataRecordFormatVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// only change when RecordFormat changes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  data_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">getContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">ContentBlock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ImageFormat</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">RAW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// RecordFormat definition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">data_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// DataLayout definition for the first block, nothing for the image block</span><br></span></code></pre></div></div>
<p>Each record has a record format version number. Each <code>RecordFormat</code>, its record format version number, and its <code>DataLayout</code> definitions are tied to a particular stream. Therefore, it is possible to have records using different <code>RecordFormat</code>/<code>DataLayout</code> definitions within a particular stream, by using different record format version numbers.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p><code>DataLayout</code> definitions fully describe what is stored in a datalayout content block. So, you can freely change <code>DataLayout</code> definitions without changing the record format version.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reading-records">Reading Records<a href="#reading-records" class="hash-link" aria-label="Direct link to Reading Records" title="Direct link to Reading Records">​</a></h2>
<p>To read records described using <code>RecordFormat</code> conventions, attach a <code>RecordFormatStreamPlayer</code> to your <code>RecordFileReader</code>. Then, hook code to whichever of these virtual methods is appropriate for your records:</p>
<ul>
<li><code>onDataLayoutRead()</code></li>
<li><code>onImageRead()</code></li>
<li><code>onAudioRead()</code></li>
<li><code>onCustomBlockRead()</code></li>
</ul>
<p>You will get one callback per content block, until one of the callbacks returns <code>false</code>, signaling that the end of the record should not be decoded.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reading-a-datalayout">Reading a Datalayout<a href="#reading-a-datalayout" class="hash-link" aria-label="Direct link to Reading a Datalayout" title="Direct link to Reading a Datalayout">​</a></h3>
<p>When reading a <code>datalayout</code> content block, you will get an <code>onDataLayoutRead</code> callback in your <code>RecordFormatStreamPlayer</code> object, with the datalayout already loaded. In the <code>onDataLayoutRead</code> callback, you will want to handle records differently, depending on their record type.</p>
<p>For each record type, you will have a specific <code>DataLayout</code> definition, describing the latest version of the datalayout you are using. But you cannot know if that definition matches what was read, since the file could be using an older or newer version of the datalayout definition. Use the <code>getExpectedLayout&lt;MyDataLayout&gt;</code> API to get a <code>DataLayout</code> instance of the type your code is looking for. You can then access each of its fields safely, with the caveat that each field may or may not find actual data in the datalayout that was read from disk.</p>
<p>Each data field is mapped according to its data type and label only. So, you do not need to worry whether fields have been added, removed, or moved. Mapping is cached per file/stream/type. So, after the first record is mapped, mapping is extremely cheap, and fields are read in constant time, no matter how complicated the datalayouts are.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>When debugging, use <code>DataLayout::printLayout(std::cout)</code> to print the incoming datalayout. This will show the field names, their type, and their value, as they are in the record read.</p></div></div>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">MyCameraStreamPlayer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="font-style:italic">public</span><span class="token base-clause"> </span><span class="token base-clause class-name" style="color:rgb(255, 203, 107)">RecordFormatStreamPlayer</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">onDataLayoutRead</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> CurrentRecord</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> record</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> size_t blockIndex</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> DataLayout</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">override</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">record</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">recordType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> Record</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Type</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">CONFIGURATION</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      MyCameraConfigRecordDataLayout</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> myConfig </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token generic-function function" style="color:rgb(130, 170, 255)">getExpectedLayout</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 107)">MyCameraConfigRecordDataLayout</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> blockIndex</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// use the data...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      myConfig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">cameraRole</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// access the data...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> Record</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">Type</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token plain">DATA</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Here are the fields written &amp; expected in the latest version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      MyCameraDataRecordDataLayout</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> myData </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token generic-function function" style="color:rgb(130, 170, 255)">getExpectedLayout</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 107)">MyCameraDataRecordDataLayout</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> blockIndex</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// use the data...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      myData</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">cameraTemperature</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Rare case: access field that were removed or renamed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// e.g., frame_counter&#x27;s type was changed: fetch the old version if necessary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">uint64_t</span><span class="token plain"> frameCounter </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">myData</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">frameCounter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">isAvailable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        frameCounter </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> myData</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">frameCounter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// MyCameraLegacyFields contains removed fields definitions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        MyCameraLegacyFields</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> legacyData </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token generic-function function" style="color:rgb(130, 170, 255)">getLegacyLayout</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 107)">MyCameraLegacyFields</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> blockIndex</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        frameCounter </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">myConversionLogic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">legacyData</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">frameCounter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">default</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// should not happen, but you want to know if it does!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// read next content blocks, if any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="datalayout-conventions">Datalayout Conventions<a href="#datalayout-conventions" class="hash-link" aria-label="Direct link to Datalayout Conventions" title="Direct link to Datalayout Conventions">​</a></h3>
<p>Datalayout Conventions are a set of names and types that VRS uses to find missing <code>RecordFormat</code> specifications, such as the resolution and pixel format, if they are missing in the definition of an <code>“image/raw”</code> content block. Datalayout Conventions can also be used to specify the size of a content block when it is ambiguous. Refer to the source header <a href="https://github.com/facebookresearch/vrs/blob/main/vrs/DataLayoutConventions.h" target="_blank" rel="noopener noreferrer"><code>&lt;vrs/DataLayoutConventions.h&gt;</code></a> to see the actual Datalayout Conventions.</p>
<p>In the examples above, you can determine the size of the datalayout blocks by looking at the actual <code>DataLayout</code> definition. However, that only works if only fixed type pieces are used. When only fixed type pieces are used, the datalayout size is constant no matter what the content is. Look again at the definition of <code>MyDataLayout</code> above to see the difference between fixed size pieces and variable size pieces.</p>
<p>When only fixed size pieces are used, the <code>getContentBlock()</code> API generates <code>&quot;datalayout/size=XXX&quot;</code>, with <code>XXX</code> being the number of bytes. If the datalayout contains any variable size pieces, the size of the datalayout can change from record to record, and the <code>getContentBlock()</code> API will return <code>&quot;datalayout&quot;</code>.</p>
<p>If any variable size pieces are present, the datalayout will include an index, which has a fixed size. The index&#x27;s size depends only on the number of variable size pieces declared, not on their actual values. This index makes it possible for VRS to determine the overall size of the <code>DataLayout</code> in two successive reads. The first read includes the data for all the fixed size pieces and the index for the variable size pieces. The added sizes found in the variable size index tells the total size of the variable size pieces, which VRS can now read with a second file read call. Therefore, VRS can always read a <code>DataLayout</code> block, because we can always determine its actual size.</p>
<p>In the second <code>RecordFormat</code> example above, we have a datalayout block followed by an image block (<code>“datalayout+image/raw”</code>). Since the image block is the last content block of the record, and VRS knows the overall size of the record, and how to figure out the size of the datalayout, we can see that all the remaining bytes must belong to the <code>“image/raw”</code> block. However, this is not sufficient to interpret the image pixel data. This is when we need the Datalayout Conventions.</p>
<p>When working with a device such as a camera, typically, during the hardware initialization/setup, before the data collection begins, the software stack will configure the camera to function in a particular mode, which includes parameters such as resolution, color mode, exposure mode, and frame rate. These parameters will never change unless the configuration of the camera is changed, which is extremely rare in practice. These parameters all belong to a configuration record and can easily be saved in a datalayout block.</p>
<p>In a more advanced system, a camera’s resolution and color mode may change for each frame, as when driven by a computer vision algorithm or some other heuristic. When you save only a sub-region of a whole image (the way Portal does when it tracks a target and crops the image received from the sensor), the crop size of the image might change in every frame. In such cases, the image parameters should not be placed in a configuration record. Those parameters should be specified in the datalayout block preceding the image block.</p>
<p>VRS uses the following heuristics:</p>
<ul>
<li>
<p>Search each datalayout block before the ambiguous block, in the same record, in reverse content block order. If the <code>RecordFormat</code> is <code>“datalayout+datalayout+image/raw+datalayout”</code>, to disambiguate the <code>“image/raw”</code> block, VRS ignores the last datalayout block (because it comes after the image/raw block), and searches the second datalayout block first. If that is not enough, it then searches the first datalayout block.</p>
</li>
<li>
<p>If the resolution and pixel format values cannot be found in the same record, VRS will search the last read configuration record in that stream.</p>
</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This look-up uses cached data. The configuration record must have been read before the data record. Reading a record will not cause another record to be read implicitly.</p></div></div>
<p>Using cached data works because <code>RecordFormatStreamPlayer</code> caches the data of the last record of each type of record it has read.</p>
<p>The Datalayout Conventions make <code>RecordFormatStreamPlayer</code> work very efficiently. For example, you get an <code>onImageRead()</code> callback, and the <code>ContentBlock</code> object is fully fleshed out, with the resolution and pixel format, which might have been specified in a configuration record a long time ago.</p>
<p>If VRS cannot determine, unambiguously, how the image block is formatted, it does not send an <code>onImageRead()</code> callback. It sends an <code>onUnsupportedBlock()</code> callback instead.</p>
<p>Datalayout Conventions can also be used to specify the size of a content block coming right after a datalayout content block. Refer to <a href="https://github.com/facebookresearch/vrs/blob/main/vrs/DataLayoutConventions.h" target="_blank" rel="noopener noreferrer"><code>&lt;vrs/DataLayoutConventions.h&gt;</code></a> for implementation details.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mistakes-to-avoid">Mistakes to Avoid<a href="#mistakes-to-avoid" class="hash-link" aria-label="Direct link to Mistakes to Avoid" title="Direct link to Mistakes to Avoid">​</a></h2>
<p>While <code>RecordFormat</code> and <code>DataLayout</code> are designed to resolve a large number of backward and forward compatibility issues, you still need to be aware of the following potential problems:</p>
<ul>
<li>
<p><strong>Do not persist any raw <code>struct</code>, always copy fields one by one.</strong> If you are receiving a data structure, such as data a C <code>struct</code> from a driver, you need to copy each field needed in that data structure into a <code>DataLayout</code>, one by one, no matter how tedious. You will also have to adjust the fields in your <code>DataLayout</code> structure when the incoming <code>struct</code> changes. You might be tempted to save the whole memory block to your VRS records, to spare yourself the work. However, doing that would make your file format vulnerable to any changes made to the struct definition, which is controlled and updated by the maintainers of that data structure. It would make it extremely difficult to understand why data read from older files look corrupt, and even harder to be able to read those files. C/C++ <code>struct</code>s do not have any data format introspection capability, and this is why VRS does not, and will not, support the use of any arbitrary <code>&lt;class T&gt;</code> in its template <code>DataPiece</code> containers. Doing so would be a massive design blunder. <em>Writing the tedious code that copies each field, one by one, from a received data structure to a copycat <code>DataLayout</code> protects your data from unexpected data format changes, and will save you hours, maybe even days, of work and frustration.</em></p>
</li>
<li>
<p><strong>Do not use <code>short</code>, <code>int</code>, or <code>size_t</code></strong> directly in any <code>DataPiece</code> template, because their size is architecture and compiler dependent, and using them can result in files that cannot be read as expected if the reading code is compiled with different configuration settings than the writing code. You should always use fully sized types, such as <code>uint8_t</code> instead. Do not use <code>size_t</code> either, because <a href="https://stackoverflow.com/questions/918787/whats-sizeofsize-t-on-32-bit-vs-the-various-64-bit-data-models" target="_blank" rel="noopener noreferrer">its size is not dependable</a>.</p>
</li>
<li>
<p><strong>Do not persist enums using <code>DataPieceValue&lt;ENUM_TYPE&gt;</code></strong> because the type of the enum is captured in the file format (<code>int</code> by default), and if the underlying type associated with the enum is ever changed, the data will no longer be accessible. Instead, use <code>DataPieceEnum&lt;ENUM_TYPE, T&gt;</code>, which captures the underlying type and performs casting. For the underlying type <code>T</code>, use a fixed-size integral type from <code>&lt;cstdint&gt;</code>, such as <code>int32_t</code> rather than ambiguous types like <code>int</code>.</p>
</li>
<li>
<p><strong>Be very careful when persisting external enums</strong> when casting them as integers to store them, because you might not control external enum definitions. You should convert external enums to text or to your own version of these enums. If the definition of an external enum changes, the code will start to misinterpret data, and it will be very difficult to fix. If you convert enums to text or create your own enums, whose evolution you control, you will avoid difficult debugging issues. If you really want to persist enums by casting their numeric value, you should create a unit test that will break when the enum values change, or you can simply add <code>static_assert</code>s to your code.</p>
</li>
<li>
<p>Creating <code>DataLayout</code> objects is relatively expensive, as they use external memory buffers and indexes, but they usually do not consume too much memory. The amount of memory used is directly proportional to the number of fields in your layout, and their size. Prefer <strong>reusing a single instance of each <code>DataLayout</code> type</strong> that you need. Update its fields before creating the record, rather than creating a new <code>DataLayout</code> object on the stack each time you need to create a record.</p>
</li>
<li>
<p>If you are using <code>AutoDataLayout</code> to build your <code>DataLayout</code> objects (like virtually everyone), be aware that their constructor uses a synchronization lock, which could potentially compromise multi-threading performance. Therefore, you <em>really</em> should be <strong>reusing a single instance of each <code>DataLayout</code> type</strong> that you need.</p>
</li>
<li>
<p>When using containers (such as <code>DataPieceVector</code> and <code>DataPieceStringMap</code>), <strong>use <code>stagedValues()</code> to update the containers</strong>, rather than creating a new container each time and calling <code>stage()</code>. This will avoid doing a new container allocation and copy each time. For most use cases, successive records are very similar, often with an identical memory footprint, and updating containers will be significantly faster this way.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-samples">Additional samples<a href="#additional-samples" class="hash-link" aria-label="Direct link to Additional samples" title="Direct link to Additional samples">​</a></h2>
<p>You can find examples of how to create and read records using <code>RecordFormat</code> and <code>DataLayout</code> here: <a href="https://github.com/facebookresearch/vrs/blob/main/sample_code/SampleRecordFormatDataLayout.cpp" target="_blank" rel="noopener noreferrer">Datalayout sample code</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-reinvent-the-wheel">Why Reinvent the Wheel?<a href="#why-reinvent-the-wheel" class="hash-link" aria-label="Direct link to Why Reinvent the Wheel?" title="Direct link to Why Reinvent the Wheel?">​</a></h2>
<p><em>What&#x27;s so special about DataLayout? Why did you not use JSON, Thrift, or some other existing serialized containers?</em></p>
<p>Historically, <code>DataLayout</code> was designed to be backward compatible with our early VRS files, which used straight-up structures of POD data. However, we now have better reasons than that. <code>DataLayout</code> leverages a specific pattern of sensor data collection, for which VRS was designed, where records are remarkably regular throughout a recording. For each device and record type, the exact same content blocks, using the same <code>DataLayout</code>s are recorded over and over again, often many millions of times.</p>
<p>For each record type in a stream, there is one <code>RecordFormat</code>, with its own set of <code>DataLayout</code> definitions, which is the dictionary of field types and labels in the datalayout content blocks of the stream. Each <code>DataLayout</code> block in the record contains only its own data, in raw binary form, which reduces processing overhead to a minimum. Therefore, the marginal cost of a <code>DataPieceValue&lt;uint8_t&gt;</code>, before compression, is one byte per record, regardless of its label, and even if it is the only field in the datalayout content block.</p>
<p>When reading and writing records, no binary-ascii conversions are made, only binary copies, and no pre or post processing of the source code is required. <code>DataLayout</code> definitions are as readable as possible, since they are <code>struct</code> definitions. The <code>DataLayout</code> definition is interpreted only once when the file is read, and the <code>DataLayout</code> that the reader expects is mapped only once to the <code>DataLayout</code> that is actually present in the stream. Therefore, reading the fields of a <code>DataLayout</code> happens in amortized constant time, with no parsing of any kind, since only pointer and size checks are required. If a field is not available in a record, the default value for that type is returned, and the <code>isAvailable()</code> method can be used to check.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-datalayout-really-good-at">What is <code>DataLayout</code> “really” good at?<a href="#what-is-datalayout-really-good-at" class="hash-link" aria-label="Direct link to what-is-datalayout-really-good-at" title="Direct link to what-is-datalayout-really-good-at">​</a></h3>
<p>All the power of <code>DataLayout</code> lies in its ability to amortize costs. Amortized, <code>DataLayout</code> objects...</p>
<ul>
<li>...store one byte of payload at the cost of 1 byte of storage (or less, because of record level compression).</li>
<li>...have zero serialization/deserialization overhead, both on read and write, including when handling data version mismatch (that’s when the data stored in a file and the definition you have when reading that file don’t match).</li>
<li>...have constant field access time, no matter how many you have.</li>
<li>...are pure binary containers (no string conversions, unlike json).</li>
<li>...require no pre-processor/code generation: <code>DataLayout</code> definitions are directly compiled by a C++ compiler.</li>
<li>...minimize memory allocations overhead. It’s possible to create and read records without memory allocations beyond record management, even when dealing with variable size arrays (vectors). Again, amortized.</li>
<li>...look, behave, and feel like a simple C++ struct: they are very readable, very easy and efficient to read and write to.</li>
</ul>
<p>The key assumption VRS makes is that data collected within each stream is extremely repetitive throughout a particular file, and everything is done to leverage that property to the fullest. So <code>DataLayout</code> stores definitions once per file, parses them once per file-read, maps the <code>DataLayout</code> format expected to the <code>DataLayout</code> found in the stream once, so all the relatively expensive operations are done only once.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-datalayout-not-good-at">What is <code>DataLayout</code> not good at?<a href="#what-is-datalayout-not-good-at" class="hash-link" aria-label="Direct link to what-is-datalayout-not-good-at" title="Direct link to what-is-datalayout-not-good-at">​</a></h3>
<ul>
<li>seamless integration with existing data representations. You will need to write converters to copy your data source(s) to your <code>DataLayout</code> definitions, field by field.</li>
<li>Nested definitions are supported, but with limitations. See <a href="https://facebookresearch.github.io/vrs/docs/RecordFormat#datalayout-examples" target="_blank" rel="noopener noreferrer">this documentation (in the “Example 2: nested definitions” tab) for details</a>. For 99% of sensor data use cases, <code>DataLayout</code> works great and this limitation isn’t even apparent, but for advanced use cases with more structured data and variable formats, of when you have nested definitions with variable size data, <code>DataLayout</code> conversion becomes a pain point.</li>
<li>complex data structures, in particular, arbitrary data structures that might change with every record, or not be known at compile time, so that converter code can not be written. In that case, you might need to use a self-described container, such as json or msgpack (which is a binary version of json). Looking at the needs of sensor data collection, this should be rare, or needed only for configuration records, which is fine, because it’s typically a one record need, and the trade offs are radically different when you need to do an operation once during setup vs. N million times in realtime. For instance, camera calibration is often stored as json in a <code>DataLayout</code> of a configuration record, and there is no reason to change that.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebookresearch/vrs/edit/main/website/docs/RecordFormat.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/vrs/docs/FilePlayback"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">File Playback</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/vrs/docs/ImageSupport"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Image Support</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#record-format-version" class="table-of-contents__link toc-highlight">Record Format Version</a></li><li><a href="#recordformat" class="table-of-contents__link toc-highlight"><code>RecordFormat</code></a><ul><li><a href="#contentblock" class="table-of-contents__link toc-highlight"><code>ContentBlock</code></a></li><li><a href="#datalayout-content-blocks" class="table-of-contents__link toc-highlight">Datalayout Content Blocks</a></li><li><a href="#datalayout-format-resilience" class="table-of-contents__link toc-highlight"><code>DataLayout</code> Format Resilience</a></li><li><a href="#datalayout-examples" class="table-of-contents__link toc-highlight"><code>DataLayout</code> Examples</a></li><li><a href="#image-audio-and-custom-content-blocks" class="table-of-contents__link toc-highlight">Image, Audio, and Custom Content Blocks</a></li></ul></li><li><a href="#registering-your-recordformat-and-datalayout-definitions" class="table-of-contents__link toc-highlight">Registering your <code>RecordFormat</code> and <code>DataLayout</code> Definitions</a></li><li><a href="#reading-records" class="table-of-contents__link toc-highlight">Reading Records</a><ul><li><a href="#reading-a-datalayout" class="table-of-contents__link toc-highlight">Reading a Datalayout</a></li><li><a href="#datalayout-conventions" class="table-of-contents__link toc-highlight">Datalayout Conventions</a></li></ul></li><li><a href="#mistakes-to-avoid" class="table-of-contents__link toc-highlight">Mistakes to Avoid</a></li><li><a href="#additional-samples" class="table-of-contents__link toc-highlight">Additional samples</a></li><li><a href="#why-reinvent-the-wheel" class="table-of-contents__link toc-highlight">Why Reinvent the Wheel?</a><ul><li><a href="#what-is-datalayout-really-good-at" class="table-of-contents__link toc-highlight">What is <code>DataLayout</code> “really” good at?</a></li><li><a href="#what-is-datalayout-not-good-at" class="table-of-contents__link toc-highlight">What is <code>DataLayout</code> not good at?</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/vrs/docs/Overview">Documentation</a></li><li class="footer__item"><a href="https://github.com/facebookresearch/vrs/tree/main/sample_code" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sample Code<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Legal (continued)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/data-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Data Policy<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/vrs/img/oss_logo.png" alt="Facebook Open Source Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/vrs/img/oss_logo.png" alt="Facebook Open Source Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">Copyright © 2025 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>