<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-FileHandler">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">The FileHandler Interface | VRS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://facebookresearch.github.io/vrs/docs/FileHandler"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="The FileHandler Interface | VRS"><meta data-rh="true" name="description" content="The VRS toolbox offers a powerful layer to abstract storage access: the FileHandler interface."><meta data-rh="true" property="og:description" content="The VRS toolbox offers a powerful layer to abstract storage access: the FileHandler interface."><link data-rh="true" rel="icon" href="/vrs/img/VRS-Icon.svg"><link data-rh="true" rel="canonical" href="https://facebookresearch.github.io/vrs/docs/FileHandler"><link data-rh="true" rel="alternate" href="https://facebookresearch.github.io/vrs/docs/FileHandler" hreflang="en"><link data-rh="true" rel="alternate" href="https://facebookresearch.github.io/vrs/docs/FileHandler" hreflang="x-default"><link rel="stylesheet" href="/vrs/assets/css/styles.a84f0846.css">
<link rel="preload" href="/vrs/assets/js/runtime~main.be2f3b2f.js" as="script">
<link rel="preload" href="/vrs/assets/js/main.d0234eb2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/vrs/"><div class="navbar__logo"><img src="/vrs/img/VRS-Icon.svg" alt="VRS Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/vrs/img/VRS-Icon.svg" alt="VRS Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">VRS</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/vrs/docs/Overview">Documentation</a><a href="/vrs/doxygen/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">C++ API Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/facebookresearch/vrs#getting-started" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Build Instructions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookresearch/vrs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/Overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/Organization">Organization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/FileStructure">File Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/FileCreation">File Creation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/FilePlayback">File Playback</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/RecordFormat">Record Format</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/ImageSupport">Image Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/vrs/docs/FileHandler">The FileHandler Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/VrsCliTool">The vrs Command Line Tool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/vrs/docs/vrsplayer">The vrsplayer App</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>The FileHandler Interface</h1></header><p>The VRS toolbox offers a powerful layer to abstract storage access: the <code>FileHandler</code> interface.</p><p><code>FileHandler</code> offers benefits similar to those of Python file-like objects, but goes beyond that by expanding the scope of “file path” to include URIs and JSON-format file specifications. It also provides mechanisms to create a <code>FileHandler</code> that will be able to interpret them.</p><p>While the <code>FileHandler</code> interface is part of the VRS toolbox, it is effectively a layer below the code that accesses the VRS files. In practice, all IO accesses made by the VRS library use <code>FileHandler</code> objects, but the <code>FileHandler</code> interface knows nothing intrinsically about VRS or any storage.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-is-filehandler-useful">Why is <code>FileHandler</code> useful?<a class="hash-link" href="#why-is-filehandler-useful" title="Direct link to heading">​</a></h2><p>VRS files are not necessarily a single file on a hard drive. They can be any of the following types of files:</p><ul><li>Chunked files on one or more local hard drives</li><li>A binary blob in cloud storage</li><li>A list of binary blobs in cloud storage (chunks in cloud storage)</li><li>Some kind of database reference that points to any of the above...</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-does-filehandler-do">What does <code>FileHandler</code> do?<a class="hash-link" href="#what-does-filehandler-do" title="Direct link to heading">​</a></h2><p>The <code>FileHandler</code> interface enables you to do the following read operations with a file:</p><ul><li>Open the file with a given path (a text string to interpret, details are below)</li><li>Provide the file size</li><li>Move the read position</li><li>Read a number of bytes</li><li>Provide caching hints</li><li>Close the file and release the allocated resources (such as file system handles and caches)</li></ul><p>At the core, that is all <code>FileHandler</code> does.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="file-paths-uris-and-json-file-specifications">File Paths, URIs, and JSON File Specifications<a class="hash-link" href="#file-paths-uris-and-json-file-specifications" title="Direct link to heading">​</a></h2><p>The primary way to identify a file is to provide a file path, but that is insufficient.</p><p>We need to be able to handle the following use cases:</p><ul><li>Chunked files</li><li>Files in cloud storage</li><li>Chunked files in cloud storage</li><li>References to a database entry, pointing to a file in another storage location</li><li>Files stored in Amazon AWS S3, Microsoft Azure, Google Cloud Storage, etc.</li></ul><p>We want to avoid making special-case implementations of our APIs and keep them simple, so using a single string to represent any path is a requirement. URIs are powerful and convenient, but chunked files quickly become difficult to represent, as chunked files can be a collection of URIs. For extreme cases, JSON appears to be the only reasonable option.</p><p>In the end, VRS supports regular file paths, URIs, and JSON file specifications, as transparently as possible.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="json-file-specifications">JSON File Specifications<a class="hash-link" href="#json-file-specifications" title="Direct link to heading">​</a></h3><p>A JSON file specification must have the following required fields:</p><ul><li><code>“storage&quot;</code>: the name of the <code>FileHandler</code> able to read that location.</li><li><code>“chunks”</code>: an ordered list of strings, each representing a chunk of the logical file, in a format that the designated <code>FileHandler</code> can handle.</li></ul><p>A valid JSON file specification can simply be as follows:<br>
<code>{&quot;storage&quot;:&quot;diskfile&quot;,&quot;chunks&quot;:[&quot;/local/folder/file.vrs&quot;]}</code></p><p>A chunked local file may look like this:<br>
<code>{&quot;storage&quot;:&quot;diskfile&quot;,&quot;chunks&quot;:[&quot;/local/folder/file.vrs&quot;,&quot;/local/folder/file.vrs_part_2&quot;]}</code></p><p>A chunked file in the cloud might be accessed using chunks published as HTTP objects, and be represented like this:<br>
<code>{&quot;storage&quot;:&quot;http&quot;,&quot;chunks&quot;:[&quot;http://cdn.meta.com/HASH1&quot;,&quot;http://cdn.meta.com/HASH2&quot;]}</code></p><p><strong>Optional Fields</strong></p><p>When dealing with objects in cloud storage, it can be expensive to do a basic operation, such as getting the size of a file chunk, particularly when you have many. Knowing how to name a file to download, and remembering how a file was originally referenced is critical. Therefore, the following optional fields have been introduced to answer these questions:</p><ul><li><code>chunk_sizes</code>: an ordered list of integers, which should match the list of <code>chunks</code>.</li><li><code>filename</code>: a name suitable to save the file locally. It might be the name of the file before it was uploaded to cloud storage.</li><li><code>source_uri</code>: a URI representation of how the object was initially represented, in particular if the JSON file specification was generated from a URI.</li></ul><p>Example:<br>
<code>{&quot;storage&quot;:&quot;http&quot;,&quot;chunks&quot;:[&quot;http://cdn.meta.com/HASH1&quot;],&quot;chunk_sizes&quot;:[123456],&quot;filename&quot;:&quot;scene23.vrs&quot;,&quot;source_uri&quot;:&quot;aria:456789&quot;}</code></p><p><strong>Extra fields</strong></p><p>Additional fields can be provided, outside of the core JSON file specifications. Extra values are string values, which name isn&#x27;t reserved for required or optional fields. These might include authentication options for some cloud storage implementations, for instance:<br>
<code>{&quot;storage&quot;:&quot;http&quot;,&quot;chunks&quot;:[&quot;http://cdn.meta.com/HASH1&quot;],&quot;source_uri&quot;:&quot;aria:456789&quot;,&quot;auth_token&quot;:&quot;09*JOYBAaSLBG@#O@&quot;}</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="uris">URIs<a class="hash-link" href="#uris" title="Direct link to heading">​</a></h3><p>URIs can be very compact and convenient, and they are commonly used already, so <code>FileHandler</code> can also handle URIs. VRS interprets the scheme part of the URI as a <code>FileHandler</code> name, and uses a <code>FileHandler</code> with that name to interpret the rest of the URI.<br>
<!-- -->Example: <code>aria:456789?auth_token=09%2AJOYBAaSLBG%40%23O%40</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="filespec"><code>FileSpec</code><a class="hash-link" href="#filespec" title="Direct link to heading">​</a></h3><p>Parsing JSON messages and URIs can become expensive if we need to repeat the operation multiple times. This is why, internally, string paths are always immediately converted into <code>FileSpec</code> objects, which are used for all file location operations.</p><p>At its core, a <code>FileSpec</code> object is simply a struct with the following public fields:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  string fileHandlerName;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  string fileName;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  string uri;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  vector&lt;string&gt; chunks;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  vector&lt;int64_t&gt; chunkSizes;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  map&lt;string, string&gt; extras;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>FileSpec</code> provides helper functions to convert to and from JSON and to get the size of a file (when specified directly). In practice, JSON file specifications and <code>FileSpec</code> objects are equivalent.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="filehandlerfactory"><code>FileHandlerFactory</code><a class="hash-link" href="#filehandlerfactory" title="Direct link to heading">​</a></h2><p>The primary role of <code>FileHandler</code> is to provide an abstract way to read files. VRS core provides a single <code>FileHandler</code> implementation that can read local files. All other <code>FileHandler</code> implementations do not belong in the VRS core. This is so that its dependencies can be limited as much as possible, and it can be easily compiled for mobile and other embedded environments.</p><p>The <code>FileHandlerFactory</code> singleton allows:</p><ul><li>Registering additional <code>FileHandler</code> implementations</li><li>Requesting the construction of <code>FileHandler</code> objects by name</li><li>Interpreting a file represented by a local file path, a URI, or a JSON file specification using the appropriate <code>FileHandler</code>.</li></ul><p><code>FileHandlerFactory</code> is a pretty small but essential class, used to open files as follows:</p><ul><li>Convert a string path into a <code>FileSpec</code></li><li>Create a <code>FileHandler</code> instance specified by name in the <code>FileSpec</code> object</li><li>Request a <code>FileHandler</code> instance to actually open the <code>FileSpec</code>, whatever that means for that <code>FileHandler</code></li><li>Return an error code and the <code>FileHandler</code> object</li></ul><p>All this is done by the <code>FileHandlerFactory</code> API as shown below:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">int FileHandlerFactory::delegateOpen(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  const string&amp; path,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  unique_ptr&lt;FileHandler&gt;&amp; outNewDelegate);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When the VRS <code>RecordFileReader</code> class opens a VRS file using the string path, the <code>FileHandlerFactory</code> API finds the <code>FileHandler</code> that is needed for all read operations. The <code>RecordFileReader</code> object does not need to know if the VRS file is local, chunked, or in cloud storage.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="further-nested-delegation">Further Nested Delegation<a class="hash-link" href="#further-nested-delegation" title="Direct link to heading">​</a></h3><p>For completeness, more levels of indirection might be required. When <code>FileHandlerFactory</code> asks <code>FileHandler</code> to open a file, it uses the <code>FileHandler</code> eponym API to open the <code>FileSpec</code>, using <code>delegateOpen</code>. This is so the <code>FileHandler</code> itself may delegate the actual handling of the <code>FileSpec</code> to yet another <code>FileHandler</code> implementation.</p><p>For example, imagine you have an HTTP <code>FileHandler</code>, which can stream data from an HTTP file. Also imagine you have a database of VRS files in cloud storage, named &quot;MyAIDataSet&quot;, which references files using a 64 bit number. You can implement a custom <code>MyAIDataSetFileHandler</code>, which accesses the MyAIDataSet database, and converts MyAIDataSet URIs into HTTP URLs. The <code>MyAIDataSetFileHandler</code> code will convert the URI, &quot;myaidataset:12345&quot;, for the MyAIDataSet dataset #12345, into a content delivery network (CDN) URL, appropriate for your computer (it might do that by looking up the dataset online using a service that will return that URL after validations and permissions checks). Then, the <code>MyAIDataSetFileHandler</code> logic will delegate reading the data from that URL to the HTTP <code>FileHandler</code> that can stream the data from an HTTP URL. The <code>RecordFileReader</code> will decode the remove VRS file just as if it were a local file, because all its file accesses are done using a <code>FileHandler</code> instance.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="interpreting-strings-as-json-file-specifications-uris-or-file-paths">Interpreting Strings as JSON File Specifications, URIs, or File Paths<a class="hash-link" href="#interpreting-strings-as-json-file-specifications-uris-or-file-paths" title="Direct link to heading">​</a></h2><p>Putting it all together, when VRS needs to interpret a string path, the following logic is used:</p><ul><li>If the string path is a JSON specification, it is converted into a <code>FileSpec</code> object with a <code>FileHandler</code> name.</li><li>If the string path is a URI, it is parsed and made into a valid <code>FileSpec</code> object, by the <code>FileHandler</code> with the same name as the URI scheme, if such a <code>FileHandler</code> is available.</li><li>Otherwise, the string path is assumed to be a local file path, that is readable to the VRS built-in disk file <code>FileHandler</code>, using the standard POSIX file APIs.</li><li>Once the <code>FileSpec</code> object is built, the <code>FileHandlerFactory</code> tries to open the file, using <code>delegateOpen()</code> to find the correct <code>FileHandler</code> for the job.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="filehandler-vs-writefilehandler"><code>FileHandler</code> vs. <code>WriteFileHandler</code><a class="hash-link" href="#filehandler-vs-writefilehandler" title="Direct link to heading">​</a></h2><p>As you may have noticed, <code>FileHandler</code> is strictly a read-only interface, because most <code>FileHandler</code> implementations, by far, only support reading. This is largely because cloud storage is usually either completely immutable, or only offers very limited creation and mutation options. Some cloud storage might only support creating new objects. Other cloud storage might only support creating new objects of constrained size, but will be able to concatenate existing objects to create new objects.</p><p>The <code>WriteFileHandler</code> classes that derive from <code>FileHandler</code> can add support for write operations, but they may not be able to support any write operations. Creating a <code>WriteFileHandler</code> is much more complicated than creating a read-only <code>FileHandler</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reading-is-easy">Reading is easy<a class="hash-link" href="#reading-is-easy" title="Direct link to heading">​</a></h3><p>A (read) <code>FileHandler</code> only really needs to implement the following operations:</p><ul><li><code>open()</code></li><li><code>close()</code></li><li><code>getFileSize()</code></li><li><code>setPos(position)</code></li><li><code>read(length)</code></li></ul><p>Effectively, cloud storage is typically stateless, and only offers support for <code>getFileSize()</code> and <code>readRange(position, length)</code>, but these can be enough to implement the <code>FileHandler</code> interface. As a result, it is easy to read cloud-stored data using the same interface as for files, even if performance will obviously differ greatly. In practice, all our <code>FileHandler</code> interfaces fully implement the read operations, or delegate them to other <code>FileHandler</code> implementations, that implement caching too.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="writing-is-complex">Writing is complex<a class="hash-link" href="#writing-is-complex" title="Direct link to heading">​</a></h3><p>You can do the following file operations with typical disk file APIs:</p><ul><li>Create a file at a location, so that an entry appears in the file system, immediately.</li><li>Write bytes to the file and extend the file.</li><li>Write more bytes to the file, and extend the file further.</li><li>Handle write requests of any size (OS system caching minimizes performance issues for you).</li><li>Seek to a past location, to read what is written before.</li><li>Overwrite or extend a file. (You cannot insert bytes into the middle of a file.)</li><li>Open an existing file to modify it.</li><li>If your app crashes or does not close the file explicitly, the data may not be fully written to disk, depending on the implementation, so it is common to have partially written files.</li></ul><p>In contrast, when writing files to a cloud storage, things typically happen as follows:</p><ul><li>Files are not actually created until the final close/commit/submit/finalize operation is performed, after a series of successful write operations.</li><li>Write operations are network operations. They have very high latencies and high error rates. Retrying file write operations is often required.</li><li>Small write operations can be extremely inefficient on the backend, in terms of storage. So, writing data in large chunks makes a huge difference.</li><li>You can not read back data you have just written, until you have finalized the object, and it is fully committed.</li><li>You can not overwrite or modify data you have already written.</li><li>If an app crashes before the upload is finalized, anything uploaded is probably lost. Some cloud storage solutions can recover partial uploads or chunks, but at the cost of added code complexity.</li></ul><p>In practice, all these constraints vary greatly between cloud storage solutions. Even if you only need to upload existing files, as they are, to a cloud storage, the cloud storage may have a maximum file size, or a chunking preference. So, if you want to store large files in the cloud, you have to chunk them and manage the chunks yourself to a certain extent.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="do-not-use-writefilehandler-implementations-directly">Do not use <code>WriteFileHandler</code> implementations directly<a class="hash-link" href="#do-not-use-writefilehandler-implementations-directly" title="Direct link to heading">​</a></h3><p>Cloud storage write operations do not provide the same type of flexibility as file APIs. Consequently, it is usually not be possible to provide a generic <code>WriteFileHandler</code> implementation - one that will work for all use cases. While any <code>FileHandler</code> implementation can safely be used to access any type of file anywhere, you cannot think of <code>WriteFileHandler</code> as something that will work for all use cases.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebookresearch/vrs/edit/main/website/docs/FileHandler.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/vrs/docs/ImageSupport"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Image Support</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/vrs/docs/VrsCliTool"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">The vrs Command Line Tool</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-is-filehandler-useful" class="table-of-contents__link toc-highlight">Why is <code>FileHandler</code> useful?</a></li><li><a href="#what-does-filehandler-do" class="table-of-contents__link toc-highlight">What does <code>FileHandler</code> do?</a></li><li><a href="#file-paths-uris-and-json-file-specifications" class="table-of-contents__link toc-highlight">File Paths, URIs, and JSON File Specifications</a><ul><li><a href="#json-file-specifications" class="table-of-contents__link toc-highlight">JSON File Specifications</a></li><li><a href="#uris" class="table-of-contents__link toc-highlight">URIs</a></li><li><a href="#filespec" class="table-of-contents__link toc-highlight"><code>FileSpec</code></a></li></ul></li><li><a href="#filehandlerfactory" class="table-of-contents__link toc-highlight"><code>FileHandlerFactory</code></a><ul><li><a href="#further-nested-delegation" class="table-of-contents__link toc-highlight">Further Nested Delegation</a></li></ul></li><li><a href="#interpreting-strings-as-json-file-specifications-uris-or-file-paths" class="table-of-contents__link toc-highlight">Interpreting Strings as JSON File Specifications, URIs, or File Paths</a></li><li><a href="#filehandler-vs-writefilehandler" class="table-of-contents__link toc-highlight"><code>FileHandler</code> vs. <code>WriteFileHandler</code></a><ul><li><a href="#reading-is-easy" class="table-of-contents__link toc-highlight">Reading is easy</a></li><li><a href="#writing-is-complex" class="table-of-contents__link toc-highlight">Writing is complex</a></li><li><a href="#do-not-use-writefilehandler-implementations-directly" class="table-of-contents__link toc-highlight">Do not use <code>WriteFileHandler</code> implementations directly</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/vrs/docs/Overview">Documentation</a></li><li class="footer__item"><a href="https://github.com/facebookresearch/vrs/tree/main/sample_code" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sample Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal (continued)</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/data-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Data Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/vrs/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/vrs/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright © 2023 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/vrs/assets/js/runtime~main.be2f3b2f.js"></script>
<script src="/vrs/assets/js/main.d0234eb2.js"></script>
</body>
</html>